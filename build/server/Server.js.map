{"version":3,"sources":["Server.js"],"names":[],"mappings":"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","file":"Server.js","sourcesContent":["import express from 'express';\r\nimport zlib from 'zlib';\r\nimport fs from 'fs';\r\nimport os from 'os';\r\nimport compression from 'compression';\r\nimport {Server as WebSocketServer} from 'ws';\r\nimport http from 'http';\r\nimport url from 'url';\r\nimport net from 'net';\r\nimport Throttle from 'throttle';\r\nimport random from 'lodash/number/random';\r\nimport indexTemplate from './templates/index';\r\nimport homeContentTemplate from './templates/homeContent';\r\nimport topNavbarTemplate from './templates/topNavbar';\r\nimport mainNavbarTemplate from './templates/mainNavbar';\r\nimport heroSliderTemplate from './templates/heroSlider';\r\nimport featuredTemplate from './templates/featured';\r\nimport infoSliderTemplate from './templates/infoSlider';\r\nimport contactTemplate from './templates/contact';\r\nimport sitemapTemplate from './templates/sitemap';\r\nimport footerTemplate from './templates/footer';\r\nimport mediaTemplate from './templates/media';\r\nimport scriptsTemplate from './templates/scripts';\r\nimport stylesTemplate from './templates/styles';\r\n\r\nconst compressor = compression({\r\n    flush : zlib.Z_PARTIAL_FLUSH\r\n});\r\n\r\nconst appServerPath = os.platform() == 'win32' ? \r\n      '\\\\\\\\.\\\\pipe\\\\offlinefirst' + Date.now() + '.sock' : \r\n      'offlinefirst.sock';\r\n\r\nconst connectionProperties = {\r\n    perfect: {bps: 100000000, delay: 0},\r\n    slow: {bps: 4000, delay: 3000},\r\n    'lie-fi': {bps: 1, delay: 10000}\r\n};\r\n\r\nexport default class Server {\r\n    constructor(port){\r\n        this._app = express();\r\n        this._sockets = [];\r\n        this._serverUp = false;\r\n        this._appServerUp = false;\r\n        this._port = port;\r\n        this._connectionType = '';\r\n        this._connections = [];\r\n        \r\n        this._appServer = http.createServer(this._app);\r\n        this._exposedServer = net.createServer();\r\n        \r\n        this._wss = new WebSocketServer({\r\n            server: this._appServer,\r\n            path: '/updates'\r\n        });\r\n        \r\n        const staticOptions = {\r\n            maxAge: 0\r\n        };\r\n        \r\n        this._exposedServer.on('connection', socket =>\r\n        this._onServerConnection(socket));\r\n        this._wss.on('connection', ws=> this._onWsConnection(ws));\r\n        this._app.use(compressor);\r\n        this._app.use('/js',express.static('../public/js',staticOptions));\r\n        this._app.use('/css',express.static('../public/css',staticOptions));\r\n        this._app.use('/imgs',express.static('../public/imgs',staticOptions));\r\n        this._app.use('/sw.js',express.static('../public/sw.js',staticOptions));\r\n        this._app.use('/sw.js.map',express.static('../public/sw.js.map',staticOptions));\r\n        this._app.use('/manifest.json',express.static('../public/manifest.json',staticOptions));\r\n        \r\n        this._app.get('/',(req,res) => {\r\n           res.send(indexTemplate({\r\n               scripts: scriptsTemplate(),\r\n               extraCss: stylesTemplate(),\r\n               topNavbar: topNavbarTemplate(),\r\n               mainNavbar: mainNavbarTemplate(),\r\n               content: homeContentTemplate({\r\n                 slider: heroSliderTemplate(),\r\n                 featured: featuredTemplate(),\r\n                 infoSlider: infoSliderTemplate(),\r\n                 contact: contactTemplate()\r\n               }),\r\n               sitemap: sitemapTemplate(),\r\n               footer: footerTemplate(),\r\n               media: mediaTemplate()\r\n           })); \r\n        });\r\n        \r\n        this._app.get('/skeleton',(req, res) => {\r\n            res.send(indexTemplate({\r\n                \r\n                scripts: scriptsTemplate(),\r\n                extraCss : stylesTemplate(),\r\n                topNavbar: topNavbarTemplate(),\r\n                mainNavbar: mainNavbarTemplate(),\r\n                content: 'MAIN CONTENT',\r\n                sitemap: sitemapTemplate(),\r\n                footer: footerTemplate(),\r\n                media: mediaTemplate()\r\n            }))\r\n        });\r\n      \r\n      this._app.get('/photos/:img', (req, res)=> {\r\n        res.sendFile('imgs/test.jpeg',{\r\n          root: __dirname + '/../public/'\r\n        });\r\n      });\r\n    }\r\n    \r\n    _onServerConnection(socket){\r\n        let closed = false;\r\n        this._connections.push(socket);\r\n        \r\n        socket.on('close', _ => {\r\n            closed = true;\r\n            this._connections.splice(this._connections.indexOf(socket), 1);\r\n        });\r\n        \r\n        socket.on('error', err=> console.log(err));\r\n        \r\n        const connection = connectionProperties[this._connectionType];\r\n        const makeConnection = _ => {\r\n            if(closed) return;\r\n            const appSocket = net.connect(appServerPath);\r\n            appSocket.on('error', err=> console.log(err));\r\n            socket.pipe(new Throttle(connection.bps)).pipe(appSocket);\r\n            appSocket.pipe(new Throttle(connection.bps)).pipe(socket);\r\n        };\r\n        \r\n        if(connection.delay){\r\n            setTimeout(makeConnection, connection.delay);\r\n            return;\r\n        }\r\n        makeConnection();\r\n    }\r\n    \r\n    _listen(){\r\n        this.serverUp = true;\r\n        this._exposedServer.listen(this._port, _=> {\r\n            console.log(\"Server listening at localhost:\" + this._port);\r\n        });\r\n        \r\n        if(!this._appServerUp){\r\n            if(fs.existsSync(appServerPath)) fs.unlinkSync(appServerPath);\r\n            this._appServer.listen(appServerPath);\r\n            this._appServerUp = true;\r\n        }\r\n    }\r\n    \r\n    _destroyConnections(){\r\n        this._connections.forEach(c => c.destroy());\r\n    }\r\n    \r\n    setConnectionType(type){\r\n        if(type === this._connectionType) return;\r\n        this._connectionType = type;\r\n        this._destroyConnections();\r\n        \r\n        if(type === 'offline'){\r\n            if(!this._serverUp) return;\r\n            this._exposedServer.close();\r\n            this._serverUp = false;\r\n            return;\r\n        }\r\n        if(!this._serverUp){\r\n            this._listen();\r\n        }\r\n    }\r\n}"],"sourceRoot":"/source/"}